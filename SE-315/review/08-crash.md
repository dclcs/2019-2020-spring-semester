# OS Review

## Crash Consistency

### 日志

#### 操作

* 在进行修改之前，先把修改记录到日志中
* 所有要进行的修改记录完毕後，提交日志
* 此後，再进行修改
* 修改完成後，删除日志

#### 崩溃

在「日志提交」之前崩溃的话，修改根本不会发生，文件也不会被创建。

在「日志提交」之後崩溃的话，恢复时会按照日志重做一次，文件创建成功。

可以看出，「提交」是分割文件创建是否成功的标志。

#### 模式

* Writeback Mode
  * 日志只记录元数据。
  * 能够恢复元数据的情况下，不一定恢复数据。
  * 不能保证数据比元数据先落盘。
* Ordered Mode
  * 日志只记录元数据，但是保证在此之前将数据块写入磁盘。
  * 数据先落盘，元数据随后到。一致性不能保证，但能恢复得到数据。
* Journal Mode
  * 日志中同时记录元数据和数据。
  * 重放日志可以把所有的数据和元数据带到一致性的状态。
  * 很慢…

#### 不一致

不一致实际上也分等级。

例如，一个 inode 被标记使用，却无法在文件系统中拿到；可能是刚进行了创建文件的第一步就 Crash 了。这是没什么危害的不一致，并且也很容易解决。

但如果说一个 inode 存在于文件系统中，甚至还指向了有效的数据块，却没被标记为已使用，这个问题就非常大了。

